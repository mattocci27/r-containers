# {{ note }}
FROM {{ baseImage }}

{% if label %}
LABEL {{ label | join('\ ') }}
{% endif %}

ENV DEBIAN_FRONTEND noninteractive

{% if systemPackages %}
RUN apt-get update -q -y \
  && apt-get install --no-install-recommends --fix-missing -y \
    {% for package in systemPackages %}
    {{ package }} \
    {% endfor %}
  && apt-get autoremove -y \
  && apt-get clean all
{% endif %}

{% if tinytex %}
ENV USER_NAME=rstudio

RUN useradd -m rstudio -u 1000 \
  && mkdir -p /home/rstudio \
  && chown -R rstudio /home/rstudio \
  && usermod -a -G staff rstudio

RUN apt-get update -qq \
    && apt-get install -y --no-install-recommends \
      apt-utils \
      curl \
      wget \
      libxt6 \
      texinfo \
      ghostscript \
      latexdiff \
    && apt-get autoremove -y \
    && apt-get autoclean -y

RUN echo "PATH=${PATH}" >> ${R_HOME}/etc/Renviron

RUN install2.r -n -2 --skipinstalled --error \
   tinytex

RUN wget -qO- \
    "https://github.com/yihui/tinytex/raw/main/tools/install-unx.sh" | \
    sh -s - --admin --no-path \
  && mv ~/.TinyTeX /opt/TinyTeX

RUN /opt/TinyTeX/bin/*/tlmgr path add \
  && tlmgr install \
    ae \
    amsmath \
    babel-english \
    bigintcalc \
    bitset \
    bookmark \
    booktabs \
    caption \
    colortbl \
    csquotes \
    environ \
    epstopdf-pkg \
    etexcmds \
    fancyhdr \
    float \
    footnotebackref \
    fvextra \
    geometry \
    gettitlestring \
    hycolor \
    hyperref \
    inconsolata \
    intcalc \
    koma-script \
    kvdefinekeys \
    kvsetkeys \
    latex-amsmath-dev \
    latexmk \
    letltxmacro \
    lineno \
    listings \
    ltxcmds \
    ly1 \
    makecell \
    mdframed \
    mdwtools \
    metafont \
    mfware \
    multirow \
    needspace \
    oberdiek \
    parskip \
    pdfcrop \
    pdfescape \
    pdflscape \
    pgf \
    refcount \
    rerunfilecheck \
    setspace \
    sourcecodepro \
    sourcesanspro \
    stringenc \
    tabu \
    tcolorbox \
    tex \
    threeparttable \
    threeparttablex \
    titling \
    trimspaces \
    ulem \
    uniquecounter \
    upquote \
    varwidth \
    wrapfig \
    xcolor \
    zapfding \
    zref \
  && tlmgr path add \
  && Rscript -e "tinytex::r_texmf()" \
  && chown -R root:staff /opt/TinyTeX \
  && chmod -R g+w /opt/TinyTeX \
  && chmod -R g+wx /opt/TinyTeX/bin
  #ae inconsolata listings metafont mfware parskip pdfcrop tex \
# RUN wget -qO- \
#     "https://github.com/yihui/tinytex/raw/main/tools/install-unx.sh" | \
#     TINYTEX_DIR=${TINYTEX_DIR} sh -s - --admin --no-path

{% endif %}

{% if quarto %}
ENV QUARTO_VERSION={{quartoVer}}

COPY scripts/install_quarto.sh  /rocker_scripts/install_quarto.sh

RUN /rocker_scripts/install_quarto.sh
{% endif %}

{% if updateLatex %}
RUN tlmgr update --self
{% endif %}

{% if crossrefVer %}
ENV PANDOC_VERSION={{pandocVer}}
ENV CROSSREF_VERSION={{crossrefVer}}

COPY scripts/install_crossref.sh  /rocker_scripts/install_crossref.sh

RUN /rocker_scripts/install_crossref.sh
{% endif %}

{% if radian %}
RUN pip3 install --default-timeout=100 -U radian
{% endif %}

{% if bio %}
RUN Rscript -e "install.packages('BiocManager')" \
  && Rscript -e "BiocManager::install(c('marray', 'affy', 'Biobase'))"
{% endif %}

{% if Rcpp %}
RUN Rscript -e "install.packages('Rcpp')"
{% endif %}

{% if installGithub %}
RUN installGithub.r --update FALSE \
    {% for github in installGithub %}
    {{ github }} \
    {% endfor %}
  && rm -rf /tmp/downloaded_packages
{% endif %}

{% if installCRAN %}
RUN install2.r -n -2 --skipinstalled --error \
    {% for cran in installCRAN %}
    {{ cran }} \
    {% endfor %}
  && rm -rf /tmp/downloaded_packages
{% endif %}

{% if gpu %}
# libtbb2 for cmdstan (cpu)
RUN apt update && apt -y install libtbb2 \
    clinfo

RUN ln -s /usr/local/cuda-10.1/targets/x86_64-linux/lib/libOpenCL.so /usr/lib/libOpenCL.so

RUN mkdir -p /etc/OpenCL/vendors && \
    echo "libnvidia-opencl.so.1" > /etc/OpenCL/vendors/nvidia.icd
{% endif %}

{% if cmdstan %}
RUN installGithub.r \
      stan-dev/cmdstanr

RUN mkdir -p  /opt/cmdstan \
 && Rscript -e "cmdstanr::install_cmdstan(dir = '/opt/cmdstan', release_url = 'https://github.com/stan-dev/cmdstan/releases/download/v2.29.0/cmdstan-2.29.0.tar.gz', cores = 2, timeout = 3600)"
{% endif %}

{% if font %}
ENV DEBIAN_FRONTEND teletype

RUN  apt-get update -q -y \
    && apt-get install ttf-mscorefonts-installer --fix-missing -y \
    && fc-cache -f \
    && apt-get autoremove -y \
    && apt-get autoclean -y

RUN install2.r -n -2 --skipinstalled --error \
  extrafont

RUN R -e 'remotes::install_version("Rttf2pt1", version = "1.3.8")'
RUN R -e 'extrafont::font_import(prompt = FALSE)'
{% endif %}
